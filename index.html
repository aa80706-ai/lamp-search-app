<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>路燈編號查詢</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',Helvetica,Arial;padding:20px;max-width:900px;margin:auto}
    input,button{font-size:16px;padding:8px;margin:4px}
    .result{border:1px solid #ddd;padding:10px;border-radius:8px;margin:8px 0}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:14px}
  </style>
</head>
<body>
  <h1>路燈編號查詢</h1>
  <div class="controls">
    <label>搜尋路燈編號: <br/><input id="query" placeholder="輸入完整路燈編號" style="width:300px"></label>
    <button id="searchBtn">搜尋</button>
  </div>
  <div id="results"></div>

<script>
function parseCSV(text){
  const rows = [];
  let cur = [];
  let field = '';
  let i = 0;
  let inQuotes = false;
  while(i < text.length){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"') { field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += ch; i++; continue; }
    }
    if(ch === '"') { inQuotes = true; i++; continue; }
    if(ch === ',') { cur.push(field); field = ''; i++; continue; }
    if(ch === '\r') { i++; continue; }
    if(ch === '\n') { cur.push(field); rows.push(cur); cur = []; field = ''; i++; continue; }
    field += ch; i++;
  }
  if(field !== '' || cur.length>0){ cur.push(field); rows.push(cur); }
  return rows;
}

let table = null;

async function loadSheet(){
  const sheetId = '1_8Hmm1mrdZgm7DUMw6w7ctDCj0WHORbG';
  const gid = '689333817';
  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
  try{
    const res = await fetch(csvUrl);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    table = parseCSV(txt);
  }catch(err){
    document.getElementById('results').innerHTML = '<div class="result">載入失敗：' + err + '</div>';
    console.error(err);
  }
}

function findByLampId(q){
  if(!table) return [];
  const results = [];
  const idIdx = 1, lonIdx = 7, latIdx = 8;
  for(let r = 0; r < table.length; r++){
    const row = table[r];
    const id = (row[idIdx] || '').toString().trim();
    const lon = (row[lonIdx] || '').toString().trim();
    const lat = (row[latIdx] || '').toString().trim();
    if(id === q) results.push({rowIndex: r, id, lon, lat});
  }
  return results;
}

function makeMapsLink(lat, lon){
  if(!lat || !lon) return null;
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat + ',' + lon)}`;
}

function showResults(items){
  const out = document.getElementById('results');
  if(!items || items.length === 0){ out.innerHTML = '<div class="result">找不到結果。</div>'; return; }
  out.innerHTML = '';
  for(const it of items){
    const div = document.createElement('div'); div.className = 'result';
    let html = `<strong>路燈編號:</strong> ${it.id} <br/><small>表列第 ${it.rowIndex+1} 列</small><br/>`;
    html += `<strong>緯度:</strong> ${it.lat || '<em>空白</em>'} <br/>`;
    html += `<strong>經度:</strong> ${it.lon || '<em>空白</em>'} <br/>`;
    if(it.lat && it.lon){
      const link = makeMapsLink(it.lat, it.lon);
      html += `<p><a target="_blank" rel="noopener" href="${link}">在 Google Maps 中開啟</a></p>`;
    } else {
      html += `<p style="color:#c00">無效或缺少座標</p>`;
    }
    div.innerHTML = html;
    out.appendChild(div);
  }
}

document.getElementById('searchBtn').addEventListener('click', ()=>{
  const q = document.getElementById('query').value.trim();
  if(!q){ alert('請輸入要搜尋的路燈編號'); return; }
  const items = findByLampId(q);
  showResults(items);
});

loadSheet();
</script>
</body>
</html>
